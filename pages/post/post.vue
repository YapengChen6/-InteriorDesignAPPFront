<template>
  <view class="container">
    <!-- 第一部分：选择帖子类型 -->
    <view class="card">
      <view class="section-title">
        <uni-icons type="tags" size="18" color="#3498db"></uni-icons>
        <text>帖子类型</text>
      </view>
      <view class="type-selector">
        <view 
          class="type-item" 
          :class="{ active: threadType === 1 }"
          @click="handleTypeChange(1)">
          <view class="type-icon">
            <uni-icons type="contact" size="24" :color="threadType === 1 ? '#3498db' : '#666'"></uni-icons>
          </view>
          <view class="type-name">作品集</view>
          <view class="type-desc">展示个人作品</view>
        </view>
        <view 
          class="type-item" 
          :class="{ active: threadType === 2 }"
          @click="handleTypeChange(2)">
          <view class="type-icon">
            <uni-icons type="list" size="24" :color="threadType === 2 ? '#3498db' : '#666'"></uni-icons>
          </view>
          <view class="type-name">案例集</view>
          <view class="type-desc">项目案例分析</view>
        </view>
        <view 
          class="type-item" 
          :class="{ active: threadType === 3 }"
          @click="handleTypeChange(3)">
          <view class="type-icon">
            <uni-icons type="paperclip" size="24" :color="threadType === 3 ? '#3498db' : '#666'"></uni-icons>
          </view>
          <view class="type-name">普通帖</view>
          <view class="type-desc">日常交流分享</view>
        </view>
        <view 
          class="type-item" 
          :class="{ active: threadType === 4 }"
          @click="handleTypeChange(4)">
          <view class="type-icon">
            <uni-icons type="shop" size="24" :color="threadType === 4 ? '#3498db' : '#666'"></uni-icons>
          </view>
          <view class="type-name">材料展示</view>
          <view class="type-desc">素材资源分享</view>
        </view>
      </view>
    </view>
    
    <!-- 第二部分：帖子表单 -->
    <view class="card">
      <view class="section-title">
        <uni-icons type="list" size="18" color="#3498db"></uni-icons>
        <text>帖子内容</text>
      </view>
      
      <view class="form-group">
        <view class="form-label">帖子标题</view>
        <uni-easyinput 
          type="text" 
          class="form-input" 
          v-model="title" 
          placeholder="请输入帖子标题"
          placeholder-style="color: #c0c4cc"
          maxlength="100"
        />
      </view>
      
      <view class="form-group">
        <view class="form-label">插入图片或视频</view>
        <view class="media-upload" @click="handleMediaUpload">
          <view class="upload-icon">
            <uni-icons type="cloud-upload" size="40" color="#95a5a6"></uni-icons>
          </view>
          <view class="upload-text">点击上传图片或视频</view>
          <view class="upload-tip">支持 JPG, PNG, MP4 格式</view>
        </view>
        
        <!-- 媒体预览 -->
        <view class="media-preview" v-if="previewMediaFiles.length > 0">
          <view class="media-list">
            <view class="media-item" v-for="(media, index) in previewMediaFiles" :key="index">
              <image 
                v-if="media.type === 'image'" 
                :src="media.tempFilePath" 
                class="media-image"
                mode="aspectFill"
                @click="previewImage(index)"
              />
              <video 
                v-else 
                :src="media.tempFilePath" 
                class="media-video"
                controls
              />
              <view class="media-remove" @click="removePreviewMedia(index)">
                <uni-icons type="close" size="16" color="#fff"></uni-icons>
              </view>
              <view class="media-status" v-if="media.uploadStatus === 'uploading'">
                <text class="status-text">上传中...</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 上传进度 -->
        <view v-if="uploadProgress > 0 && uploadProgress < 100" class="upload-progress">
          <text class="progress-text">批量上传中 {{uploadProgress}}%</text>
          <view class="progress-bar">
            <view class="progress-inner" :style="{width: uploadProgress + '%'}"></view>
          </view>
        </view>
      </view>
      
      <view class="form-group">
        <view class="form-label">帖子正文</view>
        <textarea 
          class="form-input textarea" 
          v-model="content" 
          placeholder="请输入帖子正文内容..."
          placeholder-style="color: #c0c4cc"
          maxlength="5000"
        />
        <view class="word-count">{{ content.length }}/5000</view>
      </view>
    </view>
    
    <!-- 第三部分：底部按钮 -->
    <view class="bottom-actions">
      <button class="btn btn-publish" @click="publishPost" :disabled="isSubmitting">
        {{ isSubmitting ? '发布中...' : '发布帖子' }}
      </button>
    </view>
  </view>
</template>

<script>
import { createPost, updatePost, getPostDetail } from '@/api/community'
import { uploadImage, deleteImage } from '@/api/join.js'
import { getUserProfile } from '@/api/users.js'

export default {
  data() {
    return {
      postMode: 'new', // 'new' 或 'draft'
      threadType: 3, // 帖子类型：1-作品集, 2-案例集, 3-普通帖, 4-材料展示
      title: '',
      content: '',
      categoryId: null, // 分类ID
      status: 1, // 帖子状态：0-草稿，1-发布
      previewMediaFiles: [], // 预览媒体文件（临时路径）
      uploadedMediaFiles: [], // 已上传的媒体文件（服务器返回的信息）
      editingPostId: null, // 编辑时的帖子ID
      isSubmitting: false, // 防止重复提交
      uploadProgress: 0, // 上传进度
      roleType: null, // 用户角色类型（仅用于前端逻辑，不发送到后端）
    }
  },
  
  onLoad(options) {
    // 初始化时获取用户信息
    this.getUserRoleInfo()
    
    // 如果是编辑模式，从参数获取帖子ID并加载数据
    if (options.postId) {
      this.editingPostId = options.postId
      this.loadPostData(options.postId)
    }
  },
  
  methods: {
    // 获取用户角色信息
    async getUserRoleInfo() {
      try {
        const response = await getUserProfile()
        if (response.code === 200 && response.data) {
          const userData = response.data
          // 转换角色类型为数字（仅用于前端逻辑）
          this.roleType = this.convertRoleType(userData.role_type)
          console.log('用户角色信息:', {
            originalRole: userData.role_type,
            convertedRoleType: this.roleType
          })
        }
      } catch (error) {
        console.error('获取用户角色信息失败:', error)
        // 如果获取失败，默认设为普通用户
        this.roleType = 1
      }
    },
    
    // 转换角色类型为数字
    convertRoleType(roleString) {
      const roleMap = {
        'user': 1,
        'designer': 2,
        'supervisor': 3,
        'material_supplier': 4
      }
      return roleMap[roleString] || 1 // 默认为普通用户
    },
    
    // 处理类型切换
    handleTypeChange(type) {
      this.threadType = type
    },
    
    // 加载帖子数据（编辑模式）
    async loadPostData(postId) {
      try {
        uni.showLoading({
          title: '加载中...'
        })
        
        const response = await getPostDetail(postId)
        const postData = response.data
        
        // 填充表单数据
        this.title = postData.title
        this.content = postData.content
        this.threadType = postData.threadType
        this.categoryId = postData.categoryId
        this.status = postData.status
        
        // 处理媒体文件（如果有的话，用于前端展示）
        if (postData.mediaUrls && postData.mediaUrls.length > 0) {
          this.uploadedMediaFiles = postData.mediaUrls.map(media => ({
            type: media.type || 'image',
            fileUrl: media.fileUrl,
            mediaId: media.mediaId,
            fileName: media.fileName,
            fileSize: media.fileSize,
            uploadStatus: 'completed'
          }))
        }
        
        uni.hideLoading()
        
      } catch (error) {
        console.error('加载帖子数据失败:', error)
        uni.hideLoading()
        uni.showToast({
          title: '加载帖子失败',
          icon: 'none'
        })
      }
    },
    
    // 处理媒体上传（仅选择，不上传）
    handleMediaUpload() {
      uni.showActionSheet({
        itemList: ['选择图片', '选择视频'],
        success: (res) => {
          if (res.tapIndex === 0) {
            this.chooseImage()
          } else if (res.tapIndex === 1) {
            this.chooseVideo()
          }
        }
      })
    },
    
    // 选择图片（仅预览）
    chooseImage() {
      uni.chooseImage({
        count: 9 - this.previewMediaFiles.length, // 最多9个
        sizeType: ['original', 'compressed'],
        sourceType: ['album', 'camera'],
        success: (res) => {
          for (let i = 0; i < res.tempFilePaths.length; i++) {
            this.addPreviewMedia({
              type: 'image',
              tempFilePath: res.tempFilePaths[i],
              fileInfo: res.tempFiles[i],
              uploadStatus: 'pending' // 等待上传
            })
          }
        }
      })
    },
    
    // 选择视频（仅预览）
    chooseVideo() {
      uni.chooseVideo({
        sourceType: ['album', 'camera'],
        maxDuration: 60,
        camera: 'back',
        success: (res) => {
          this.addPreviewMedia({
            type: 'video',
            tempFilePath: res.tempFilePath,
            fileInfo: {
              size: res.size,
              type: 'video/mp4'
            },
            uploadStatus: 'pending' // 等待上传
          })
        }
      })
    },
    
    // 添加预览媒体
    addPreviewMedia(media) {
      this.previewMediaFiles.push(media)
    },
    
    // 删除预览媒体
    removePreviewMedia(index) {
      uni.showModal({
        title: '提示',
        content: '确定要删除这个文件吗？',
        success: (res) => {
          if (res.confirm) {
            this.previewMediaFiles.splice(index, 1)
            uni.showToast({
              title: '删除成功',
              icon: 'success',
              duration: 2000
            })
          }
        }
      })
    },
    
    // 预览图片
    previewImage(index) {
      const imageUrls = this.previewMediaFiles
        .filter(media => media.type === 'image')
        .map(media => media.tempFilePath)
      
      const currentIndex = this.previewMediaFiles
        .slice(0, index)
        .filter(media => media.type === 'image')
        .length
      
      uni.previewImage({
        urls: imageUrls,
        current: currentIndex
      })
    },
    
    // 批量上传媒体文件
    async uploadAllMediaFiles(postId) {
      const pendingMedia = this.previewMediaFiles.filter(media => media.uploadStatus === 'pending')
      
      if (pendingMedia.length === 0) {
        return this.uploadedMediaFiles
      }
      
      this.uploadProgress = 0
      const totalFiles = pendingMedia.length
      let completedFiles = 0
      
      for (let i = 0; i < pendingMedia.length; i++) {
        const media = pendingMedia[i]
        const index = this.previewMediaFiles.findIndex(m => m.tempFilePath === media.tempFilePath)
        
        if (index !== -1) {
          // 更新状态为上传中
          this.previewMediaFiles[index].uploadStatus = 'uploading'
          
          try {
            // 使用传入的帖子ID进行上传，related_type固定为3
            const result = await this.uploadSingleMediaFile(
              media.tempFilePath, 
              media.type, 
              media.fileInfo, 
              postId
            )
            
            if (result.code === 200) {
              // 上传成功，添加到已上传列表
              const uploadedMedia = {
                type: media.type,
                fileUrl: result.data.fileUrl,
                mediaId: result.data.mediaId,
                fileName: result.data.fileName,
                fileSize: result.data.fileSize,
                uploadStatus: 'completed'
              }
              this.uploadedMediaFiles.push(uploadedMedia)
              
              // 更新预览文件状态
              this.previewMediaFiles[index].uploadStatus = 'completed'
            } else {
              throw new Error(result.msg || result.message || '上传失败')
            }
          } catch (error) {
            console.error(`上传文件失败: ${media.tempFilePath}`, error)
            this.previewMediaFiles[index].uploadStatus = 'failed'
            throw error
          }
          
          // 更新进度
          completedFiles++
          this.uploadProgress = Math.round((completedFiles / totalFiles) * 100)
        }
      }
      
      return this.uploadedMediaFiles
    },
    
    // 上传单个媒体文件
    async uploadSingleMediaFile(filePath, fileType, fileInfo, postId) {
      try {
        if (fileInfo.size > 50 * 1024 * 1024) {
          throw new Error('文件大小不能超过50MB')
        }
        
        const relatedType = 3 // 固定为3，根据你的要求
        const relatedId = postId ? Number(postId) : 0 // 使用传入的帖子ID
        const description = `帖子${fileType === 'image' ? '图片' : '视频'}`
        const stage = 'post'
        const sequence = this.uploadedMediaFiles.length + 1
        
        console.log('📤 上传文件参数:', {
          filePath,
          relatedType, // 固定为3
          relatedId,   // 帖子ID
          description,
          stage,
          sequence
        })
        
        const response = await uploadImage(
          filePath,
          relatedType,
          relatedId,
          description,
          stage,
          sequence
        )
        
        console.log('✅ 上传成功:', response)
        return response
        
      } catch (error) {
        console.error('❌ 上传失败:', error)
        throw error
      }
    },
    
    // 构建帖子数据（移除roleType字段）
    buildPostData() {
      const baseData = {
        title: this.title.trim(),
        content: this.content.trim(),
        threadType: this.threadType
      }
      
      // 添加可选字段
      if (this.categoryId) {
        baseData.categoryId = this.categoryId
      }
      
      if (this.status !== undefined) {
        baseData.status = this.status
      }
      
      console.log('📦 构建的帖子数据:', baseData)
      return baseData
    },
    
    // 表单验证
    validateForm() {
      if (!this.title.trim()) {
        uni.showToast({
          title: '请输入帖子标题',
          icon: 'none'
        })
        return false
      }
      
      if (this.title.trim().length < 2) {
        uni.showToast({
          title: '标题至少需要2个字符',
          icon: 'none'
        })
        return false
      }
      
      if (!this.content.trim()) {
        uni.showToast({
          title: '请输入帖子内容',
          icon: 'none'
        })
        return false
      }
      
      return true
    },
    
    // 发布帖子
    async publishPost() {
      if (this.isSubmitting) return
      
      if (!this.validateForm()) return
      
      this.isSubmitting = true
      
      try {
        let postId = this.editingPostId
        
        // 第一步：创建帖子（发布状态）
        const postData = this.buildPostData()
        postData.status = 1 // 发布状态
        
        let result
        if (this.editingPostId) {
          // 如果是编辑模式，使用updatePost
          result = await updatePost(this.editingPostId, postData)
        } else {
          // 如果是新建模式，使用createPost
          result = await createPost(postData)
          console.log('📝 创建帖子返回:', result)
          if (result.code === 200 && result.data) {
            // 提取帖子ID，注意：result.data可能是字符串 "5"
            postId = String(result.data) // 确保是字符串类型
            this.editingPostId = postId // 更新编辑帖子ID
            console.log('✅ 获取到帖子ID:', postId)
          } else {
            throw new Error('创建帖子失败: ' + (result.message || '未知错误'))
          }
        }
        
        // 第二步：如果有预览文件，使用帖子ID上传文件
        if (this.previewMediaFiles.length > 0 && postId) {
          uni.showLoading({
            title: '上传文件中...'
          })
          await this.uploadAllMediaFiles(postId)
          uni.hideLoading()
        }
        
        uni.showToast({
          title: '帖子发布成功',
          icon: 'success'
        })
        
        // 清空预览文件
        this.previewMediaFiles = []
        
        // 发布成功后返回上一页
        setTimeout(() => {
          uni.navigateBack()
        }, 1500)
        
      } catch (error) {
        console.error('发布帖子失败:', error)
        uni.showToast({
          title: '发布帖子失败: ' + error.message,
          icon: 'none'
        })
      } finally {
        this.isSubmitting = false
        this.uploadProgress = 0
      }
    }
  }
}
</script>

<style lang="scss" scoped>
.container {
  background-color: #f5f7fa;
  min-height: 100vh;
  padding: 15px;
  padding-bottom: 100px;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 15px;
  color: #2c3e50;
  display: flex;
  align-items: center;
}

.section-title text {
  margin-left: 8px;
}

.type-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 10px;
}

.type-item {
  flex: 1;
  min-width: 120px;
  border: 1px solid #e1e8ed;
  border-radius: 8px;
  padding: 15px 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.type-item.active {
  border-color: #3498db;
  background-color: rgba(52, 152, 219, 0.05);
  color: #3498db;
}

.type-icon {
  margin-bottom: 8px;
}

.type-name {
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
}

.type-desc {
  font-size: 12px;
  color: #7f8c8d;
}

.form-group {
  margin-bottom: 20px;
  position: relative;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #2c3e50;
}

.form-input {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #e1e8ed;
  border-radius: 8px;
  font-size: 15px;
  transition: border 0.3s;
  box-sizing: border-box;
}

.form-input:focus {
  border-color: #3498db;
}

.textarea {
  min-height: 150px;
  font-family: inherit;
}

.word-count {
  position: absolute;
  right: 10px;
  bottom: 10px;
  font-size: 12px;
  color: #95a5a6;
}

.media-upload {
  border: 2px dashed #e1e8ed;
  border-radius: 8px;
  padding: 30px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 10px;
}

.media-upload:active {
  border-color: #3498db;
  background-color: rgba(52, 152, 219, 0.03);
}

.upload-icon {
  margin-bottom: 10px;
}

.upload-text {
  color: #7f8c8d;
  font-size: 14px;
  margin-bottom: 5px;
}

.upload-tip {
  color: #95a5a6;
  font-size: 12px;
}

.media-preview {
  margin-top: 15px;
}

.media-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.media-item {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: 6px;
  overflow: hidden;
}

.media-image {
  width: 100%;
  height: 100%;
}

.media-video {
  width: 100%;
  height: 100%;
}

.media-remove {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 20px;
  height: 20px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

/* 新增状态样式 */
.media-status {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
}

.status-text {
  color: white;
  font-size: 12px;
  text-align: center;
}

.upload-progress {
  margin-top: 15rpx;
  width: 100%;
}

.progress-text {
  font-size: 24rpx;
  color: #3498db;
  text-align: center;
  display: block;
  margin-bottom: 10rpx;
}

.progress-bar {
  width: 100%;
  height: 6rpx;
  background-color: #e0e0e0;
  border-radius: 3rpx;
  overflow: hidden;
}

.progress-inner {
  height: 100%;
  background-color: #3498db;
  border-radius: 3rpx;
  transition: width 0.3s ease;
}

.bottom-actions {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 15px;
  display: flex;
  gap: 15px;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08);
}

.btn {
  flex: 1;
  padding: 14px 0;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-publish {
  background: #3498db;
  color: white;
}

.btn-publish:active:not(:disabled) {
  background: #2980b9;
}

@media (max-width: 480px) {
  .container {
    padding: 10px;
    padding-bottom: 100px;
  }
  
  .card {
    padding: 15px;
  }
  
  .type-item {
    min-width: calc(50% - 6px);
    padding: 12px 5px;
  }
}
</style>